name: Build and Upload Electron App

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build Electron app (x64)
        run: npm run build:x64

      - name: Download WinSCP (alternative version)
        run: |
          # Try a different version
          try {
              Invoke-WebRequest -Uri "https://sourceforge.net/projects/winscp/files/WinSCP/5.21.8/WinSCP-5.21.8-Portable.zip/download" -OutFile "winscp.zip" -UseBasicParsing
          } catch {
              # Fallback to direct GitHub mirror or chocolatey
              Write-Host "Trying alternative download..."
              Invoke-WebRequest -Uri "https://github.com/winscp/winscp/releases/download/v5.21.8/WinSCP-5.21.8-Portable.zip" -OutFile "winscp.zip" -UseBasicParsing
          }
          
          # Verify file size before extracting
          $fileSize = (Get-Item "winscp.zip").Length
          Write-Host "Downloaded file size: $fileSize bytes"
          
          if ($fileSize -lt 1000000) {  # Less than 1MB is suspicious
              throw "Downloaded file seems too small, possibly corrupted"
          }
          
          Expand-Archive -Path "winscp.zip" -DestinationPath "winscp" -Force
        shell: powershell
